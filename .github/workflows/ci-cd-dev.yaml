name: Deploy to Development
 
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image to deploy'
        required: true
      sha:
        description: 'Git SHA of the commit'
        required: true
      commit_message:
        description: 'Original commit message'
        required: true


jobs:   
  deploy-frontend-dev:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Display Deployment Information
        run: |
          echo "Image: ${{ github.event.inputs.image }}"
          echo "SHA: ${{ github.event.inputs.sha }}"
          echo "Commit Message: ${{ github.event.inputs.commit_message }}"
          
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Set frontend image tag from dispatch input
        run: echo "FRONTEND_IMAGE=${{ github.event.inputs.image }}" >> $GITHUB_ENV

      - name: Update deployment image tag in Kustomization
        run: |
          # Update the image tag in the deployment patch
          sed -i 's|image: "[^"]*"|image: "'"$FRONTEND_IMAGE"'"|' k8s/overlays/dev/kustomization.yaml

      - name: Commit and push changes
        run: |
          git config --local user.email "hariharen@greatify.ai"
          git config --local user.name "Hariharen"
          git add k8s/overlays/dev/kustomization.yaml
          
          # Check if there are any changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit, skipping commit and push"
          else
            echo "Changes detected, committing and pushing"
            git commit -m "Update image tags for dev deployment"
            git push origin main
          fi

      # - name: Push to protected branch
      #   uses: CasperWA/push-protected@v2
      #   with:
      #     token: ${{ secrets.PAT_TOKEN }}
      #     branch: dev
      #     unprotect_reviews: true

      - name: Configure AWS credentials for deployment
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update Kubernetes configuration
        run: aws eks update-kubeconfig --name dev-stg-cluster --region ap-south-1

      - name: Deploy to development environment
        run: |
          kubectl apply -k k8s/overlays/dev

      - name: Send deployment success notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          author_name: Frontend Deployment Success
          mention: ${{ github.actor }}
          if_mention: success
          job_name: deploy-frontend-dev
          channel: examxv2-frontend-alerts
          username: ExamX-V2-CICD
          text: |
            :rocket: *Frontend deployment to dev environment succeeded*
            
            *Deployment by:* @${{ github.actor }}
            *Commit:* ${{ github.event.inputs.sha }}
            *Commit message:* ${{ github.event.inputs.commit_message }}
            
            @${{ github.actor }}, your changes have been deployed successfully to Development.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
