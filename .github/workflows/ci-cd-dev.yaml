name: Deploy to Development
 
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image to deploy'
        required: true
      sha:
        description: 'Git SHA of the commit'
        required: true

jobs:   
  deploy-frontend:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Debug Info
        run: |
          echo "Image: ${{ github.event.inputs.image }}"
          echo "SHA: ${{ github.event.inputs.sha }}"
          
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set image tag from dispatch input
        run: echo "FRONTEND_IMAGE=${{ github.event.inputs.image }}" >> $GITHUB_ENV

      - name: Update Frontend React deployment image tag
        run: |
          # Update the image tag in the deployment patch
          sed -i 's|image: "[^"]*"|image: "'"$FRONTEND_IMAGE"'"|' k8s/overlays/dev/kustomization.yaml

      - name: Commit changes
        run: |
          git config --local user.email "hariharen@greatify.ai"
          git config --local user.name "Hariharen"
          git add k8s/overlays/dev/kustomization.yaml
          git commit -m "Update image tags for dev deployment"
          git push origin main

      # - name: Push to protected branch
      #   uses: CasperWA/push-protected@v2
      #   with:
      #     token: ${{ secrets.PAT_TOKEN }}
      #     branch: dev
      #     unprotect_reviews: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kube config
        run: aws eks update-kubeconfig --name dev-stg-cluster --region ap-south-1

      - name: Apply Kubernetes configuration to Dev
        run: |
          kubectl apply -k k8s/overlays/dev

      - name: Slack Notification on Successful Deployment
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,eventName,ref,workflow
          author_name: Frontend Deployment Success
          mention: ${{ github.actor }}
          if_mention: success
          job_name: deploy-dev
          channel: examxv2-frontend-alerts
          username: ExamX-V2-CICD
          text: |
            :rocket: *Frontend deployment to dev environment succeeded*
            *Pusher:* `${{ github.actor }}`
            @${{ github.actor }}, your changes have been deployed successfully. Please verify the deployment in the dev environment.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
